// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Basic User model - will be expanded later
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  image     String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  stockAccounts   StockAccount[]
  pensionAccounts PensionAccount[]
  miscAssets      MiscAsset[]

  @@map("users")
}

// Stock Portfolio Models
model StockAccount {
  id        String   @id @default(cuid())
  name      String   // e.g., "Fidelity Brokerage", "Robinhood"
  broker    String?  // e.g., "Fidelity", "Robinhood", "Interactive Brokers"
  currency  String   @default("USD") // Account currency (USD, ILS, EUR, etc.)
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user     User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  holdings StockHolding[]

  @@map("stock_accounts")
}

model StockHolding {
  id           String   @id @default(cuid())
  symbol       String   // Stock ticker symbol (e.g., "AAPL", "GOOGL")
  quantity     Decimal  @db.Decimal(18, 8) // Number of shares (supports fractional)
  avgCostBasis Decimal  @map("avg_cost_basis") @db.Decimal(18, 4) // Average cost per share
  accountId    String   @map("account_id")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  account StockAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@unique([accountId, symbol]) // One holding per symbol per account
  @@map("stock_holdings")
}

model StockPriceHistory {
  id        String   @id @default(cuid())
  symbol    String   // Stock ticker symbol
  price     Decimal  @db.Decimal(18, 4) // Current/cached price
  timestamp DateTime @default(now()) // When this price was fetched

  @@unique([symbol, timestamp])
  @@index([symbol])
  @@map("stock_price_history")
}

// Pension/Hishtalmut Models
enum PensionAccountType {
  pension
  hishtalmut
}

model PensionAccount {
  id             String             @id @default(cuid())
  type           PensionAccountType
  providerName   String             @map("provider_name") // e.g., "Meitav", "Altshuler Shaham"
  accountName    String             @map("account_name")  // User-defined name
  currentValue   Decimal            @map("current_value") @db.Decimal(18, 2) // Current total value
  feeFromDeposit Decimal            @map("fee_from_deposit") @db.Decimal(5, 4) // Fee % from each deposit
  feeFromTotal   Decimal            @map("fee_from_total") @db.Decimal(5, 4) // Annual management fee %
  userId         String             @map("user_id")
  createdAt      DateTime           @default(now()) @map("created_at")
  updatedAt      DateTime           @updatedAt @map("updated_at")

  // Relations
  user     User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  deposits PensionDeposit[]

  @@map("pension_accounts")
}

model PensionDeposit {
  id          String   @id @default(cuid())
  depositDate DateTime @map("deposit_date") @db.Date // When money was deposited
  salaryMonth DateTime @map("salary_month") @db.Date // Which month's salary (first of month)
  amount      Decimal  @db.Decimal(18, 2) // Deposit amount
  employer    String   // Company name
  accountId   String   @map("account_id")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  account PensionAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([salaryMonth])
  @@map("pension_deposits")
}

// Misc. Assets / Debt Models
enum MiscAssetType {
  bank_deposit
  loan
  mortgage
  child_savings
}

model MiscAsset {
  id             String        @id @default(cuid())
  type           MiscAssetType
  name           String                                                   // User-defined name
  currentValue   Decimal       @map("current_value") @db.Decimal(18, 2)   // Positive for assets, negative for debts
  interestRate   Decimal       @map("interest_rate") @db.Decimal(5, 4)    // Annual % (0.05 = 5%)
  monthlyPayment Decimal?      @map("monthly_payment") @db.Decimal(18, 2) // For loans/mortgages
  monthlyDeposit Decimal?      @map("monthly_deposit") @db.Decimal(18, 2) // For savings plans
  maturityDate   DateTime?     @map("maturity_date") @db.Date             // When deposit matures or loan ends
  userId         String        @map("user_id")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("misc_assets")
}
