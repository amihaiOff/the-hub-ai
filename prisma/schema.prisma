// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Verification tokens for magic link authentication
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// User model - authentication entity
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  image     String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Profile relation (1:1 optional)
  profile Profile?

  // Legacy relations (kept during migration, will be removed later)
  stockAccounts     StockAccount[]
  pensionAccounts   PensionAccount[]
  miscAssets        MiscAsset[]
  netWorthSnapshots NetWorthSnapshot[]

  @@map("users")
}

// Profile - represents a person whose finances are tracked
// Can be linked to a User (for login) or standalone (for family members)
model Profile {
  id        String   @id @default(cuid())
  name      String
  image     String?
  color     String?  @default("#3b82f6") // UI accent color for identification
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Optional User link (null for non-login profiles like children)
  userId String? @unique @map("user_id")
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Household memberships (many-to-many)
  householdMemberships HouseholdMember[]

  // Asset ownership (many-to-many via junction tables)
  stockAccountOwners   StockAccountOwner[]
  pensionAccountOwners PensionAccountOwner[]
  miscAssetOwners      MiscAssetOwner[]

  // Budget transactions attributed to this profile
  budgetTransactions BudgetTransaction[]

  @@map("profiles")
}

// Household - groups profiles together (family/unit)
model Household {
  id          String   @id @default(cuid())
  name        String
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Members
  members HouseholdMember[]

  // Budget module relations
  budgetCategoryGroups BudgetCategoryGroup[]

  @@map("households")
}

// HouseholdMember - junction table with role
enum HouseholdRole {
  owner
  admin
  member
}

model HouseholdMember {
  id          String        @id @default(cuid())
  householdId String        @map("household_id")
  profileId   String        @map("profile_id")
  role        HouseholdRole @default(member)
  joinedAt    DateTime      @default(now()) @map("joined_at")

  // Relations
  household Household @relation(fields: [householdId], references: [id], onDelete: Cascade)
  profile   Profile   @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@unique([householdId, profileId])
  @@map("household_members")
}

// Junction tables for asset ownership (supports multi-profile ownership)
model StockAccountOwner {
  id        String @id @default(cuid())
  accountId String @map("account_id")
  profileId String @map("profile_id")

  account StockAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)
  profile Profile      @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@unique([accountId, profileId])
  @@map("stock_account_owners")
}

model PensionAccountOwner {
  id        String @id @default(cuid())
  accountId String @map("account_id")
  profileId String @map("profile_id")

  account PensionAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)
  profile Profile        @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@unique([accountId, profileId])
  @@map("pension_account_owners")
}

model MiscAssetOwner {
  id        String @id @default(cuid())
  assetId   String @map("asset_id")
  profileId String @map("profile_id")

  asset   MiscAsset @relation(fields: [assetId], references: [id], onDelete: Cascade)
  profile Profile   @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@unique([assetId, profileId])
  @@map("misc_asset_owners")
}

// Stock Portfolio Models
model StockAccount {
  id        String   @id @default(cuid())
  name      String   // e.g., "Fidelity Brokerage", "Robinhood"
  broker    String?  // e.g., "Fidelity", "Robinhood", "Interactive Brokers"
  currency  String   @default("USD") // Account currency (USD, ILS, EUR, etc.)
  userId    String?  @map("user_id") // Legacy - nullable during migration
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Legacy relation (kept during migration)
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  // New ownership relation
  owners       StockAccountOwner[]
  holdings     StockHolding[]
  cashBalances StockAccountCash[]

  @@map("stock_accounts")
}

// Cash balance in a stock account - supports multiple currencies
model StockAccountCash {
  id        String   @id @default(cuid())
  accountId String   @map("account_id")
  currency  String   // e.g., "USD", "ILS", "EUR"
  amount    Decimal  @db.Decimal(18, 2) // Cash balance in this currency
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  account StockAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@unique([accountId, currency]) // One balance per currency per account
  @@map("stock_account_cash")
}

model StockHolding {
  id           String   @id @default(cuid())
  symbol       String   // Stock ticker symbol (e.g., "AAPL", "GOOGL")
  name         String?  // Full stock name (e.g., "Apple Inc.")
  taseSymbol   String?  @map("tase_symbol") // TASE equivalent symbol for dual-listed stocks
  quantity     Decimal  @db.Decimal(18, 8) // Number of shares (supports fractional)
  avgCostBasis Decimal  @map("avg_cost_basis") @db.Decimal(18, 4) // Average cost per share
  accountId    String   @map("account_id")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  account StockAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@unique([accountId, symbol]) // One holding per symbol per account
  @@map("stock_holdings")
}

model StockPriceHistory {
  id        String   @id @default(cuid())
  symbol    String   // Stock ticker symbol
  price     Decimal  @db.Decimal(18, 4) // Current/cached price
  timestamp DateTime @default(now()) // When this price was fetched

  @@unique([symbol, timestamp])
  @@index([symbol])
  @@map("stock_price_history")
}

// Pension/Hishtalmut Models
enum PensionAccountType {
  pension
  hishtalmut
}

model PensionAccount {
  id             String             @id @default(cuid())
  type           PensionAccountType
  providerName   String             @map("provider_name") // e.g., "Meitav", "Altshuler Shaham"
  accountName    String             @map("account_name")  // User-defined name
  currentValue   Decimal            @map("current_value") @db.Decimal(18, 2) // Current total value
  feeFromDeposit Decimal            @map("fee_from_deposit") @db.Decimal(5, 4) // Fee % from each deposit
  feeFromTotal   Decimal            @map("fee_from_total") @db.Decimal(5, 4) // Annual management fee %
  userId         String?            @map("user_id") // Legacy - nullable during migration
  createdAt      DateTime           @default(now()) @map("created_at")
  updatedAt      DateTime           @updatedAt @map("updated_at")

  // Legacy relation (kept during migration)
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  // New ownership relation
  owners   PensionAccountOwner[]
  deposits PensionDeposit[]

  @@map("pension_accounts")
}

model PensionDeposit {
  id          String   @id @default(cuid())
  depositDate DateTime @map("deposit_date") @db.Date // When money was deposited
  salaryMonth DateTime @map("salary_month") @db.Date // Which month's salary (first of month)
  amount      Decimal  @db.Decimal(18, 2) // Deposit amount
  employer    String   // Company name
  accountId   String   @map("account_id")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  account PensionAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([salaryMonth])
  @@map("pension_deposits")
}

// Misc. Assets / Debt Models
enum MiscAssetType {
  bank_deposit
  loan
  mortgage
  child_savings
}

model MiscAsset {
  id             String        @id @default(cuid())
  type           MiscAssetType
  name           String                                                   // User-defined name
  currentValue   Decimal       @map("current_value") @db.Decimal(18, 2)   // Positive for assets, negative for debts
  interestRate   Decimal       @map("interest_rate") @db.Decimal(5, 4)    // Annual % (0.05 = 5%)
  monthlyPayment Decimal?      @map("monthly_payment") @db.Decimal(18, 2) // For loans/mortgages
  monthlyDeposit Decimal?      @map("monthly_deposit") @db.Decimal(18, 2) // For savings plans
  maturityDate   DateTime?     @map("maturity_date") @db.Date             // When deposit matures or loan ends
  userId         String?       @map("user_id") // Legacy - nullable during migration
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  // Legacy relation (kept during migration)
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  // New ownership relation
  owners MiscAssetOwner[]

  @@index([userId])
  @@map("misc_assets")
}

// Net Worth Snapshots - bi-weekly historical records for graph
model NetWorthSnapshot {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  date      DateTime @db.Date // Snapshot date (1st or 15th of month)
  netWorth  Decimal  @map("net_worth") @db.Decimal(18, 2)
  portfolio Decimal  @db.Decimal(18, 2) // Stock portfolio value
  pension   Decimal  @db.Decimal(18, 2) // Total pension/hishtalmut value
  assets    Decimal  @db.Decimal(18, 2) // Net misc assets value (assets - debts)
  createdAt DateTime @default(now()) @map("created_at")

  // Relation to User for referential integrity
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date]) // One snapshot per user per date
  @@index([userId])
  @@index([date])
  @@map("net_worth_snapshots")
}

// ============================================
// BUDGET MODULE - Monthly Budget Tracking
// ============================================

enum TransactionType {
  income
  expense
}

enum TransactionSource {
  manual
  bank_import
  credit_card_import
}

enum PaymentMethod {
  cash
  credit_card
  bank_transfer
  check
  other
}

// Budget Category Groups - organize categories into logical groups
model BudgetCategoryGroup {
  id          String   @id @default(cuid())
  name        String
  sortOrder   Int      @default(0) @map("sort_order")
  householdId String   @map("household_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  household  Household        @relation(fields: [householdId], references: [id], onDelete: Cascade)
  categories BudgetCategory[]

  @@unique([householdId, name]) // Unique group names per household
  @@index([householdId])
  @@map("budget_category_groups")
}

// Budget Categories - individual budget categories within groups
model BudgetCategory {
  id          String   @id @default(cuid())
  name        String
  groupId     String   @map("group_id")
  budget      Decimal? @db.Decimal(18, 2) // Monthly budget amount (null = no budget)
  isMust      Boolean  @default(false) @map("is_must") // Essential vs discretionary
  sortOrder   Int      @default(0) @map("sort_order")
  householdId String   @map("household_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  group        BudgetCategoryGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  transactions BudgetTransaction[]
  payees       BudgetPayee[]       // Payees with this as default category

  @@unique([groupId, name]) // Unique category names per group
  @@index([householdId])
  @@index([groupId])
  @@map("budget_categories")
}

// Budget Payees - who you transact with
model BudgetPayee {
  id          String   @id @default(cuid())
  name        String
  categoryId  String?  @map("category_id") // Default category for this payee
  householdId String   @map("household_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  category     BudgetCategory?     @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  transactions BudgetTransaction[]

  @@unique([householdId, name]) // Unique payee names per household
  @@index([householdId])
  @@index([categoryId])
  @@map("budget_payees")
}

// Budget Tags - labels for transactions
model BudgetTag {
  id          String   @id @default(cuid())
  name        String
  color       String   @default("#3B82F6") // Hex color code
  householdId String   @map("household_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  transactionTags BudgetTransactionTag[]

  @@unique([householdId, name]) // Unique tag names per household
  @@index([householdId])
  @@map("budget_tags")
}

// Budget Transactions - income and expense records
model BudgetTransaction {
  id                    String            @id @default(cuid())
  type                  TransactionType
  transactionDate       DateTime          @map("transaction_date") @db.Date
  paymentDate           DateTime?         @map("payment_date") @db.Date // For credit cards
  amountIls             Decimal           @map("amount_ils") @db.Decimal(18, 2)
  currency              String            @default("ILS") // Original currency
  amountOriginal        Decimal           @map("amount_original") @db.Decimal(18, 2) // Amount in original currency
  categoryId            String?           @map("category_id")
  payeeId               String?           @map("payee_id")
  paymentMethod         PaymentMethod     @default(credit_card) @map("payment_method")
  paymentNumber         Int?              @map("payment_number") // For installments (e.g., 2 of 6)
  totalPayments         Int?              @map("total_payments") // Total installments
  notes                 String?
  source                TransactionSource @default(manual)
  isRecurring           Boolean           @default(false) @map("is_recurring")
  isSplit               Boolean           @default(false) @map("is_split") // Is this a parent split transaction?
  originalTransactionId String?           @map("original_transaction_id") // Reference to parent if this is a split child
  profileId             String?           @map("profile_id") // Which household member made the transaction
  householdId           String            @map("household_id")
  createdAt             DateTime          @default(now()) @map("created_at")
  updatedAt             DateTime          @updatedAt @map("updated_at")

  // Relations
  category        BudgetCategory?        @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  payee           BudgetPayee?           @relation(fields: [payeeId], references: [id], onDelete: SetNull)
  profile         Profile?               @relation(fields: [profileId], references: [id], onDelete: SetNull)
  tags            BudgetTransactionTag[]
  // Self-relation for split transactions
  originalTransaction BudgetTransaction?   @relation("SplitTransactions", fields: [originalTransactionId], references: [id], onDelete: Cascade)
  splitChildren       BudgetTransaction[]  @relation("SplitTransactions")

  @@index([householdId])
  @@index([transactionDate])
  @@index([categoryId])
  @@index([payeeId])
  @@index([profileId])
  @@index([originalTransactionId])
  @@map("budget_transactions")
}

// Junction table for transaction tags (many-to-many)
model BudgetTransactionTag {
  id            String @id @default(cuid())
  transactionId String @map("transaction_id")
  tagId         String @map("tag_id")

  // Relations
  transaction BudgetTransaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  tag         BudgetTag         @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([transactionId, tagId])
  @@index([transactionId])
  @@index([tagId])
  @@map("budget_transaction_tags")
}
